\begin{algorithm}
    \caption{CAPO: Context-Aware Prompt Optimization}
    \begin{algorithmic}[1]
    \Require Dataset $\mathcal{D} = \{(X_i, y_i)\}_{i=1}^n$, Meta-LLM $\Phi(x)$, Downstream LLM $\phi(x)$, Cost function $\ell(y, \hat{y})$, Initial prompts $\nu$, Population size $p$, Block size $b$, Number of iterations $n$
    \State Divide dataset $\mathcal{D}$ into blocks $\mathcal{B} = \{B_1, ..., B_k\}$ where $|B_i| = b$
    \State Create $d \in \mathbb{R}^x$ for fewshot examples
    \For{$i=1$ to $n$}
        \State $P \gets \text{random\_selection}(\nu)$
        \State $O \gets \text{cross\_over}(P)$
        \State $\nu \gets \nu.\text{update}(O)$
        \State $\nu \gets \text{mutate}(\nu)$
        \State prepend few-shot examples to $\nu$
        \State $\nu \gets \text{do\_racing}(\nu, \text{top\_k}=p)$
    \EndFor
    \State $\text{best\_prompt} \gets \text{do\_racing}(\nu, \text{top\_k}=1)$
    \State \Return best\_prompt
    \end{algorithmic}
\end{algorithm}

\begin{algorithm}
    \caption{do\_racing}
    \begin{algorithmic}[1]
    \Require Prompts $\nu$, Top-$k$ $p$, cost function $\ell(y, \hat{y})$, blocks $\mathcal{B}$, Downstream LLM $\phi(x)$
    \State survivors $\gets \nu$
    \State $i \gets 0$
    \State scores $\gets [0]*\text{len}(\nu)$
    \State shuffle $\mathcal{B}$
    \While{$\text{len(survivors)} > \text{top\_k} \ \land \ i < \text{len}(\mathcal{B})$}
        \State $i \gets i + 1$
        \State $\text{scores} \gets \frac{1}{i}\left(\text{evaluate}(\nu, B_i) + (i-1)*\text{scores}\right)$
        \State $\text{survivors} \gets \text{racing\_elimination}(\nu, \text{scores}, i*b, \alpha, k)$
    \EndWhile 
    \State \Return survivors
    \end{algorithmic}
\end{algorithm}

\begin{algorithm}
    \caption{Confidence-based Racing Elimination}
    \begin{algorithmic}[1]
    \Require Prompts $P$, scores $S$, number of evaluations $a$, confidence level $\alpha$, total blocks $B$, top $k$
    \State $z_{\alpha} \gets \Phi^{-1}(1-\alpha/2)$ \Comment{Critical value}
    \State survivors $\gets P$
    \For{$p_i \in P$}
        \If{$\sum_{j \neq i} \mathbf{1}_{\left((s_j - s_i)\sqrt{a} > z_{\alpha}\right)} \geq k$} \Comment{\# prompts better than $p_i$ exceeds $k$}
            \State survivors $\gets$ survivors $\setminus \{p_i\}$ \Comment{Eliminate $p_i$}
        \EndIf
    \EndFor
    \State \Return survivors
    \end{algorithmic}
\end{algorithm}